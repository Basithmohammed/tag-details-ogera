<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OGERA Service</title>
    <link rel="icon" type="image/png" href="logo.jpeg">
    
    <!-- EmailJS -->
    <script src="https://cdn.emailjs.com/dist/email.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

    <!-- Choices.js for searchable dropdown -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

    <script>
        (function () {
            emailjs.init("EL0iKkv9XdLt50uLZ");
        })();
    </script>

    <style>
        body {
            background: linear-gradient(135deg, #1f1f1f, #2c2c2c);
            min-height: 100vh;
            margin: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Segoe UI', Arial, sans-serif;
        }

        #salesForm {
            background: #2b2b2b;
            padding: 40px 35px;
            border-radius: 16px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            min-width: 350px;
            max-width: 450px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 15px;
            color: #f0f0f0;
        }

        #salesForm h2 {
            text-align: center;
            color: #00c6ff;
            margin-bottom: 20px;
            font-size: 1.8rem;
        }

        #salesForm label {
            font-weight: 600;
            color: #e0e0e0;
        }

        #salesForm select,
        #salesForm input,
        #salesForm textarea {
            padding: 12px 14px;
            border: 1px solid #555;
            border-radius: 8px;
            font-size: 1rem;
            background: #3a3a3a;
            color: #f0f0f0;
            outline: none;
        }

        #salesForm select:focus,
        #salesForm input:focus,
        #salesForm textarea:focus {
            border-color: #00c6ff;
            box-shadow: 0 0 8px rgba(0, 198, 255, 0.4);
        }

        #salesForm textarea {
            resize: none;
        }

        #salesForm button {
            padding: 12px 0;
            border: none;
            border-radius: 8px;
            background: #00c6ff;
            color: #1f1f1f;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }

        #salesForm button:hover {
            background: #00a0cc;
        }

        .choices__inner {
            color: #000 !important;
            background-color: #fff !important;
        }

        .choices__list--dropdown .choices__item--choice {
            color: #000 !important;
        }

        #salesPersonId,
        #productId,
        #dealerContact {
            background: #e0e0e0 !important;
            color: #000 !important;
        }
    </style>
</head>

<script>
    // Check if user is logged in
    const user = sessionStorage.getItem('loggedInUser');
    if (!user) {
        // Redirect to login page if not logged in
        window.location.href = 'login.html';
    } else {
        // Optional: Pre-fill Sales Person field if needed
        const salesPersonMap = { "Irshad": "1", "Sajith": "2", "Sujith": "3" };
        const salesPersonIdMap = { "Irshad": "SP001", "Sajith": "SP002", "Sujith": "SP003" };
        const selectElem = document.getElementById('salesPerson');

        if (selectElem) {
            selectElem.value = salesPersonMap[user];
            document.getElementById('salesPersonId').value = salesPersonIdMap[user];

            // Trigger change to populate dealer dropdown
            const event = new Event('change');
            selectElem.dispatchEvent(event);
        }
    }
</script>

<body>
    <form id="salesForm">
        <h2>Submit Tag Details</h2>

        <label for="salesPerson">Sales Person:</label>
        <select id="salesPerson" name="salesPerson" required>
            <option value="" disabled>Select Sales Person</option>
            <option value="1" data-id="4004">Irshad</option>
            <option value="2" data-id="SP002">Sajith</option>
            <option value="3" data-id="SP003">Sujith</option>
        </select>
        <input type="text" id="salesPersonId" name="salesPersonId" placeholder="Sales Person ID" readonly>

        <label for="product">Product:</label>
        <select id="product" name="product" required>
            <option value="" disabled selected>Select Product</option>
            <option value="A" data-id="P1001">Pressure Cooker</option>
            <option value="B" data-id="P1002">Blender</option>
            <option value="C" data-id="P1003">Toaster</option>
        </select>
        <input type="text" id="productId" name="productId" placeholder="Product ID" readonly>

        <label for="productSerial">Product Serial Number:</label>
        <input type="text" id="productSerial" name="productSerial" placeholder="Enter Serial Number" required>

        <label for="dealerName">Dealer Name:</label>
        <select id="dealerName" name="dealerName" required>
            <option value="" disabled selected>Select Dealer</option>
        </select>

        <label for="dealerContact">Dealer Contact Number:</label>
        <input type="tel" id="dealerContact" name="dealerContact" required pattern="[0-9]{10}" placeholder="Dealer contact will appear here" readonly>

        <label for="complaint">Complaint:</label>
        <textarea id="complaint" name="complaint" rows="3" placeholder="Enter complaint details here..." required></textarea>

        <label for="complaintDate">Complaint Date:</label>
        <input type="date" id="complaintDate" name="complaintDate" required>

        <button type="submit">Submit</button>
    </form>

    <script>
        const salesPersonDealers = {
            "1": [
                { name: "4Yu Supermarket Chattiparmbil", contact: "9745600701", email: "dealerA1@email.com" },
                { name: "AAK HYPER MARKET TIRUR", contact: "9400330553", email: "dealerA2@email.com" },
                { name: "Aishwarya Metals, Kondotty", contact: "9895107127", email: "dealerA1@email.com" },
                { name: "Aishwarya Supermarket, Pulikkal", contact: "8281848356", email: "dealerA2@email.com" },
                { name: "Akam Home Appliances. EDAKKARA", contact: "9048812818", email: "dealerA1@email.com" },
                { name: "AL AMEEN HOME CENTRE", contact: "9846206951", email: "dealerA2@email.com" },
                { name: "Al Ghazali Pathrapura. Kondotty", contact: "9495306100", email: "dealerA1@email.com" },
                { name: "Alfa Appliances. Areekode", contact: "8547411276", email: "dealerA2@email.com" },
                { name: "ANSAS HOME LAND", contact: "9446949479", email: "" },
                { name: "Arafa Home Needs. EKKAPARAMBA", contact: "9048793031", email: "dealerA1@email.com" },
                { name: "Arafa Store.Morayur", contact: "9388825351", email: "dealerA2@email.com" },
                { name: "ASAS HOUSE LAND", contact: "7034948969", email: "dealerA1@email.com" },
                { name: "BHANUSHA AGENCIES, CHELARI", contact: "9846543759", email: "dealerA2@email.com" },
                { name: "Bharath Home Needs.AIKKARAPPADI", contact: "9847973847", email: "dealerA1@email.com" },
                { name: "BISMI HOME NEEDS", contact: "8590522831", email: "dealerA2@email.com" },
                { name: "BRK Home Needs Trippanachi", contact: "8089352010", email: "dealerA1@email.com" },
                { name: "Brothers Home Appliances,,mooripaadam", contact: "9567265736", email: "dealerA2@email.com" },
                { name: "Budget Home Needs,Pookkoottumpadam", contact: "9447681490", email: "" }
            ],
            "2": [
                { name: "Dealer B1", contact: "9988776655", email: "dealerB1@email.com" }
            ],
            "3": [
                { name: "Dealer C1", contact: "9090909090", email: "dealerC1@email.com" },
                { name: "Dealer C2", contact: "9191919191", email: "dealerC2@email.com" }
            ]
        };

        const salesPersonEmails = {
            "1": "m.basith@ogeraglobal.com",
            "2": "bob.smith@ogeraglobal.com",
            "3": "charlie.lee@ogeraglobal.com"
        };

        const salesHeadEmail = "service@ogeraglobal.com";

        document.addEventListener('DOMContentLoaded', function () {
            window.dealerChoices = new Choices('#dealerName', { searchEnabled: true, itemSelectText: '', shouldSort: false });

            // ðŸŸ¢ Set today's date automatically
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('complaintDate').value = today;

            // Auto-fill Sales Person from login
            const user = sessionStorage.getItem('loggedInUser');
            if (user) {
                const salesPersonMap = { "Irshad": "1", "Sajith": "2", "Sujith": "3" };
                const salesPersonIdMap = { "Irshad": "SP001", "Sajith": "SP002", "Sujith": "SP003" };
                const salesPersonSelect = document.getElementById('salesPerson');
                salesPersonSelect.value = salesPersonMap[user];
                document.getElementById('salesPersonId').value = salesPersonIdMap[user];

                // Populate dealers automatically
                const dealers = salesPersonDealers[salesPersonSelect.value] || [];
                window.dealerChoices.clearChoices();
                window.dealerChoices.setChoices(
                    dealers.map((dealer, idx) => ({
                        value: idx.toString(),
                        label: dealer.name,
                        customProperties: { contact: dealer.contact }
                    })), 'value', 'label', false
                );
            }
        });

        document.getElementById('salesPerson').addEventListener('change', function () {
            const selectedId = this.options[this.selectedIndex].getAttribute('data-id');
            document.getElementById('salesPersonId').value = selectedId;

            const dealers = salesPersonDealers[this.value] || [];
            window.dealerChoices.clearChoices();
            window.dealerChoices.setChoices(
                dealers.map((dealer, idx) => ({
                    value: idx.toString(),
                    label: dealer.name,
                    customProperties: { contact: dealer.contact }
                })), 'value', 'label', false
            );
            document.getElementById('dealerContact').value = '';
        });

        document.getElementById('product').addEventListener('change', function () {
            document.getElementById('productId').value = this.options[this.selectedIndex].getAttribute('data-id') || '';
        });

        document.getElementById('dealerName').addEventListener('change', function () {
            const selectedIdx = this.value;
            const salesPersonValue = document.getElementById('salesPerson').value;
            const selectedDealer = (salesPersonDealers[salesPersonValue] || [])[selectedIdx];
            document.getElementById('dealerContact').value = selectedDealer ? selectedDealer.contact : '';
        });

        document.getElementById('salesForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const autoCode = 'TAG-' + Math.floor(100000 + Math.random() * 900000);

            const salesPersonSelect = document.getElementById('salesPerson');
            const salesPersonId = document.getElementById('salesPersonId').value;
            const salesPersonName = salesPersonSelect.options[salesPersonSelect.selectedIndex].text;
            const salesPersonEmail = salesPersonEmails[salesPersonSelect.value];

            const productSelect = document.getElementById('product');
            const productId = document.getElementById('productId').value;
            const productName = productSelect.options[productSelect.selectedIndex].text;
            const productSerial = document.getElementById('productSerial').value;

            const dealerSelect = document.getElementById('dealerName');
            const dealerName = dealerSelect.options[dealerSelect.selectedIndex].text;
            const dealerContact = document.getElementById('dealerContact').value;

            const complaint = document.getElementById('complaint').value;
            const complaintDate = document.getElementById('complaintDate').value;

            const templateParams = {
                sales_person_name: salesPersonName,
                sales_person_id: salesPersonId,
                product_name: productName,
                product_id: productId,
                product_serial: productSerial,
                dealer_name: dealerName,
                dealer_contact: dealerContact,
                complaint: complaint,
                complaint_date: complaintDate,
                auto_code: autoCode
            };

            // Email to Sales Person
            emailjs.send('service_tj3qg0s', 'template_e59692j', { ...templateParams, to_email: salesPersonEmail })
                .then(() => {
                    // Email to Sales Head
                    emailjs.send('service_tj3qg0s', 'template_e59692j', { ...templateParams, to_email: salesHeadEmail })
                        .then(() => {
                            alert('Form submitted and emails sent!');
                            document.getElementById('salesForm').reset();
                            document.getElementById('salesPersonId').value = '';
                            document.getElementById('productId').value = '';
                            document.getElementById('dealerContact').value = '';
                            window.dealerChoices.clearChoices();
                        })
                        .catch(error => alert('Failed to send email to sales head: ' + error.text));
                })
                .catch(error => alert('Failed to send email to sales person: ' + error.text));
        });
    </script>
</body>
</html>
